<!DOCTYPE html>
{% load i18n %}
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
    .select2-container {
        width: 260px ! important;
    }
    .span{
        color: red; 
        font-weight: bold;
    }
    .divBtn{
        text-align: center;
    }
    .contenedor{
        width: 45%;
        height: 22%;
        margin: 0 auto;
        border: solid #ccc9c9;
    }
    .form{
        margin: 0 auto;
        padding-top:3%;
    }

    input[type=number] {
        -moz-appearance:textfield; /* Firefox */
        text-align: center;
    }
    input[type=text] {
        text-align: center;
    }
    input[type=checkbox] {
     -ms-transform: scale(1.5); /* IE */
     -moz-transform: scale(1.5); /* FF */
     -webkit-transform: scale(1.5); /* Safari and Chrome */
     -o-transform: scale(1.5); /* Opera */
      padding: 10px;
    }
      .pac-container {
        z-index: 10000 !important;
    }
</style>
     <link type="text/css" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
</head>
<body>
<input id="prop" value="{{propiedad}}" hidden disabled>
                            <div class="alert alert-info alert-dismissible fade show" role="alert">
                                <strong>{%trans 'Look up your address!' %} </strong>
                                {%trans "We'll try to auto-complete this form for you, if it isn't possible, please fill it out yourself"%}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
<div class="container">
    <div class="row">
        <form id="formUno" method="post" class="form">
            {% csrf_token %}
            <div class="col-md-12">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="col-md-12">

                        <div class="row">
                            <div class="col-md-4">
                                {{form.errors}}
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                {{form.tipo_via.label}}<span class="span"> *</span></label>
                                <div class="col-md-12 col-lg-8 offset-lg-2">
                                    {{form.tipo_via}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                    {{form.via.label}}<span class="span"> *</span>
                                </label>
                                <div class="col-md-12 col-lg-8 offset-lg-2">
                                    {{form.via}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                    {{form.prefijo_via.label}}
                                </label>
                                <div class="col-md-12 col-lg-6 offset-lg-2">
                                    {{form.prefijo_via}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                        {{form.numero.label}}<span class="span"> *</span>
                                    </label>
                                    <div class="col-md-12 col-lg-8 offset-lg-2">
                                        {{form.numero}}
                                        <span class="help-block"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                    {{form.prefijo_numero.label}}
                                </label>
                                <div class="col-md-12 col-lg-6 offset-lg-2">
                                    {{form.prefijo_numero}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                    {{form.placa.label}}<span class="span"> *</span>
                                </label>
                                <div class="col-md-12 col-lg-8 offset-lg-2">
                                    {{form.placa}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-4">
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                    {{form.departamento.label}}<span class="span"> *</span>
                                </label>
                                <div class="col-md-12 col-lg-10 offset-lg-2">
                                    {{form.departamento}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                    {{form.ciudad.label}}<span class="span"> *</span>
                                </label>
                                <div class="col-md-12 col-lg-10 offset-lg-2">
                                    {{form.ciudad}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="col-md-12 col-sm-12 col-xs-12 control-label">
                                    {{form.barrio.label}}
                                </label>
                                <div class="col-md-12 col-lg-8 offset-lg-2">
                                    {{form.barrio}}
                                    <span class="help-block"></span>
                                </div>
                            </div>
                        </div>

                             {{form.propiedad}}

                        <br/>
                        <hr>
                        <div class="row">
                            <div class="col-sm-9 col-md-7 col-lg-4>
                                <label class="control-label">
                                    <p>{% trans 'Show full address in web:' %}</p>
                                </label>
                            </div>
                            <div class="col-sm-3 col-md-3 col-lg-2">
                                {{form.mostrar}}
                            </div>
                        </div>
                        <div style=" text-align: center;">
                            <span style="font-size: 18px;">{% trans 'Address to be shown:' %}</span>
                            <span style="font-weight: bold;" id="showData2"></span>
                        </div>
                    </div>
                </div>
            </div>
            <br/>
            <div class="form-group divBtn">
                <div class="col-md-12">
                    <button type="submit" id="btnGuardar" class="btn btn-primary btnSave" style="background-color:#364e68;">
                        {% trans 'save' %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4Gol1U3BbHLkWzeJb5kbggvFAPVKZRAA&libraries=places&callback=initAutocomplete"
            async defer></script>
</body>

<!--<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.7/js/select2.min.js"></script>-->
<script>
    $(".alert").hide()
    document.getElementById('id_tipo_via').className="route";
    document.getElementById('id_via').className="via";
    document.getElementById('id_prefijo_via').className="pre_via";
    document.getElementById('id_prefijo_numero').className="pre_num";
    document.getElementById('id_numero').className="street_number_1";
    document.getElementById('id_placa').className="street_number_2";
    document.getElementById('id_departamento').className="administrative_area_level_1";
    document.getElementById('id_ciudad').className="locality";
    document.getElementById('id_barrio').className="neighborhood";
    var city;
    var val_city;
    var placeSearch, autocomplete;

    function getCities() {
        var opcion = $("#id_departamento option:selected").val();
        depa = $("#id_departamento option:selected").text();
        $.ajax({
            url: '{% url "city:cities" %}',
            type: 'get',
            data: { 'id': opcion }
        }).done(function(data) {
            var valores = '';
            var datos = JSON.parse(data);
            $("#id_ciudad").empty();
            valores = "<option value='' selected>Ciudad</option>"
            $.each(datos, function(item, val) {
                valores += "<option value='" + val.pk + "'>" + val.fields.name + "</option>";
            });
            $("#id_ciudad").append(valores);
            $("#id_ciudad").val(city_id);
        });
        datos();
    }
var componentForm = {
  street_number: 'short_name',
  route: 'long_name',
  locality: 'long_name',
  administrative_area_level_1: 'short_name',

  //country: 'long_name',
  neighborhood: 'short_name'
};

function initAutocomplete() {
  // Create the autocomplete object, restricting the search predictions to
  // geographical location types.
  let addressIn = document.getElementById('autocomplete');
  autocomplete = new google.maps.places.Autocomplete(
  addressIn, {types: ['(cities)'], componentRestrictions: {country: 'co'}});

  // Avoid paying for data that you don't need by restricting the set of
  // place fields that are returned to just the address components.
  autocomplete.setFields(['address_component']);

  // When the user selects an address from the drop-down, populate the
  // address fields in the form.
  autocomplete.addListener('place_changed', fillInAddress);
}
function fillInAddress() {
  // Get the place details from the autocomplete object.
  var place = autocomplete.getPlace();

  // Get each component of the address from the place details,
  // and then fill-in the corresponding field on the form.
  for (var i = 0; i < place.address_components.length; i++) {
    var addressType = place.address_components[i].types[0];
    if (componentForm[addressType]) {
      var val = place.address_components[i][componentForm[addressType]];
      switch (addressType){
        case "route":
            let value = val.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            let route = value.split(' ');
            if (route.length > 1){
                let tipoVia = document.getElementsByClassName('route')[0];
                if (route[0] === 'Avenida'){
                    let streetType = route[0] + ' ' +route[1].toLowerCase();
                    setSelectedValue(tipoVia,streetType);
                }else{ setSelectedValue(tipoVia, route[0]);}
                if (route[route.length - 1] === 'Sur') {
                    direction = route[route.length - 1].toUpperCase();
                    let numPref = route[1].match(/[a-z]+|[^a-z]+/gi);
                    let prefix = document.getElementsByClassName('pre_via')[0];
                    if (numPref.length > 1){
                        prefixUpper = numPref[1].toUpperCase();
                        document.getElementsByClassName('via')[0].value = numPref[0];
                        setSelectedValue(prefix, prefixUpper + ' ' + direction);
                    }else if (route.length === 4) {
                        document.getElementsByClassName('via')[0].value = numPref;
                        setSelectedValue(prefix, route[2].toUpperCase() + ' ' + direction)
                    }else{
                        document.getElementsByClassName('via')[0].value = numPref;
                        setSelectedValue(prefix, direction)
                    }
                }else{
                    let numPref = route[route.length - 1].match(/[a-z]+|[^a-z]+/gi);
                    let prefix = document.getElementsByClassName('pre_via')[0];
                    if (numPref.length > 1){
                        prefixUpper = numPref[1].toUpperCase();
                        document.getElementsByClassName('via')[0].value = numPref[0];
                        setSelectedValue(prefix, prefixUpper);
                    }else {
                        document.getElementsByClassName('via')[0].value = numPref;
                        prefix.options[0].selected = true;
                    }
                }
            }else{ alert("{% trans "We've tried our best to autocomplete. Please check the form" %}")}

            break;
        case "administrative_area_level_1":
          var val_dept =val.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
          dept = document.getElementsByClassName(addressType)[0];
          dept.options[0].selected = true;
          if (val_dept === 'BOGOTA'){
            setSelectedValue(dept, 'CUNDINAMARCA');
          }else{ setSelectedValue(dept, val_dept);}
          setSelectedValue(city, val_city);
          break;
        case "locality":
          val_city = val.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
          city = document.getElementsByClassName(addressType)[0];
          break;
        case "street_number":
             let street = val.split('-');
             console.log(val)
             console.log(street)
             let prefix2 = document.getElementsByClassName('pre_num')[0];
            if ( street.length > 1) {
                let number = street[0].replace('#', '' );
                let placa = street[1];
                let numPref2 = number.match(/[a-z]+|[^a-z]+/gi);
                console.log(numPref2)
                if (numPref2.length > 1){
                console.log(numPref2[1].toUpperCase())
                    document.getElementsByClassName('street_number_1')[0].value = numPref2[0]
                    let pxNum =numPref2[1].toUpperCase()
                    setSelectedValue(prefix2, pxNum);
                }else{document.getElementsByClassName('street_number_1')[0].value = number;
                document.getElementsByClassName('street_number_2')[0].value = placa;
                prefix2.options[0].selected = true;
                }
            }else{
                let withprex = val.match(/[a-z]+|[^a-z]+/gi);
                if ( withprex.length > 2){
                    let pxNum = withprex[1].toUpperCase()
                    setSelectedValue(prefix2, pxNum);
                    document.getElementsByClassName('street_number_1')[0].value = withprex[0];
                    document.getElementsByClassName('street_number_2')[0].value = withprex[2];
                } else{
                    if (val.length > 1){
                        document.getElementsByClassName('street_number_1')[0].value = val.substring(0, val.length/2 + val.length % 2);
                        document.getElementsByClassName('street_number_2')[0].value = val.substring(val.length/2 + val.length % 2, val.length);
                        prefix2.options[0].selected = true;
                    }else{
                     document.getElementsByClassName('street_number_1')[0].value = val;
                     document.getElementsByClassName('street_number_2')[0].value = '';
                     prefix2.options[0].selected = true;
                    }
                    alert("{% trans "We've tried our best to autocomplete. Please check the form" %}")
                }
            }
           // $("#id_departamento").trigger('change');
            $("#id_prefijo_via").trigger('change');
            $("#id_prefijo_numero").trigger('change');
            $("#id_ciudad").trigger("change");
            $("#id_mostrar").trigger("change");
            break;
        default:
            document.getElementsByClassName(addressType)[0].value = val;
            break;
      }
      datos()
    }
  }

  function setSelectedValue(selectObj, valueToSet) {
  console.log(valueToSet)
    for (var i = 0; i < selectObj.options.length; i++) {
        if (selectObj.options[i].text== valueToSet) {
            selectObj.options[i].selected = true;
            return;
        }
    }
    }
}

// Bias the autocomplete object to the user's geographical location,
// as supplied by the browser's 'navigator.geolocation' object.
function geolocate() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var geolocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      var circle = new google.maps.Circle(
          {center: geolocation, radius: position.coords.accuracy});
      autocomplete.setBounds(circle.getBounds());
    });
  }
}
//SECTION 2
    var  depa = '';
    var  ciud = '';
    var  pref = '';
    var  prefNum = '';
    $("#id_prefijo_via").change(function(){
        pref = $("#id_prefijo_via option:selected").text();
        datos();
    });

    $("#id_prefijo_numero").change(function(){
        prefNum = $("#id_prefijo_numero option:selected").text();
        datos();
    });
    // show dept and city in mostrar address (trick)


    $("#id_departamento").change(function(){
        getCities();
    });

    $("#id_ciudad").change(function(){
        ciud = $("#id_ciudad option:selected").text();
        datos();
    });

    var propy = $("#prop").val();
    $("#id_propiedad").val(propy).change();
    $('label[for="id_propiedad"]').hide();
    $("#id_propiedad").hide()

    //Css
    $("input, select").addClass('form-control');
    $("#id_mostrar").prop('checked',true);

    if(  $("#id_mostrar").is(':checked') ){
        }

    function datos(){
    $("#showData2").text('');
        if( $("#id_mostrar").is(':checked') ){
         $("#showData2").text($("#id_tipo_via").val()+' '+$("#id_via").val()+' '+$("#id_prefijo_via").val()+' '+$("#id_numero").val() +' # '+$("#id_prefijo_numero").val()+' - '+$("#id_placa").val()+' '+$("#id_ciudad option:selected").text()+', '+$("#id_departamento option:selected").text()+', '+$("#id_barrio").val() );
        }else{
            $("#showData2").html( $("#id_barrio").val()+' '+$("#id_ciudad option:selected").text()+' '+$("#id_departamento option:selected").text() );
        }
    }

    $("#id_tipo_via, #id_via, #id_prefijo_via, #id_numero, #id_prefijo_numero, #id_placa, #id_ciudad, #id_departamento, #id_barrio").change(function () {
        $("#showData2").html( $("#id_barrio").val()+' '+$("#id_departamento option:selected").text()+', '+$("#id_ciudad option:selected").text() );
        datos();
    });


    if( $("#id_mostrar").is(':checked') ){
        datos();
    }

    $("#id_mostrar").change(function() {
            datos();
    });

    var city_id = $("#id_ciudad").val();
    $( document ).ready(function() {
        datos()
    });

    $("#autocomplete").focus( function (){
        $(".alert").show()
    })

</script>
</html>
